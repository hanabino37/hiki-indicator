{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://hanabino37.github.io/hiki-indicator/schema/machine.schema.json",
  "title": "Hiki Indicator Machine Schema (benchmarks-first)",
  "description": "機種ごとの入力/出力と、基準比較(benchmarks)の定義。導入月・号機・タイプ等は任意。",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "machineId",
    "name",
    "io"
  ],
  "properties": {
    "schemaVersion": { "type": "string", "pattern": "^1\\.0\\.0$" },
    "machineId": {
      "type": "string",
      "pattern": "^[a-z0-9]([a-z0-9-_]{0,30}[a-z0-9])$",
      "description": "PNG名やlocalStorageキーに使う安定ID（2–32、a-z0-9-_）"
    },
    "name": {
      "type": "object",
      "required": ["jp"],
      "additionalProperties": false,
      "properties": {
        "jp": { "type": "string", "minLength": 1 },
        "en": { "type": "string" }
      }
    },
    "tags": { "type": "array", "items": { "type": "string" }, "uniqueItems": true },
    "references": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["title", "url"],
        "properties": {
          "title": { "type": "string" },
          "url": { "type": "string", "format": "uri" }
        }
      }
    },
    "notes": { "type": "string" },
    "labelsJP": {
      "type": "object",
      "additionalProperties": { "type": "string" },
      "description": "UIラベル辞書（キー=任意のI/Oキー）"
    },
    "io": {
      "type": "object",
      "required": ["inputs", "outputs"],
      "additionalProperties": false,
      "properties": {
        "inputs": { "type": "array", "items": { "$ref": "#/$defs/fieldDef" }, "minItems": 0 },
        "outputs": { "type": "array", "items": { "$ref": "#/$defs/fieldDef" }, "minItems": 0 }
      }
    },
    "scoring": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "method": { "type": "string", "enum": ["ratio", "z", "shrinkage"] },
        "params": { "type": "object", "additionalProperties": true }
      }
    },
    "benchmarks": {
      "type": "object",
      "description": "キー=メトリクス名（例: atHitRate / rareFlagRate / atAvgCoins など）",
      "additionalProperties": {
        "type": "object",
        "required": ["method"],
        "additionalProperties": false,
        "properties": {
          "method": { "type": "string", "enum": ["ratio", "diff", "z"] },
          "baseline": { "type": "number" },
          "stddev": { "type": "number" },
          "numeratorKey": { "type": "string" },
          "denominatorKey": { "type": "string" },
          "higherIsBetter": { "type": "boolean", "default": true },
          "bands": {
            "type": "array",
            "description": "色分け用の閾値 [b1,b2,b3,b4]（白<青<黄<緑<赤 の境界）。ratio/diffは相対偏差、zはz値をそのまま比較。",
            "items": { "type": "number" },
            "minItems": 4,
            "maxItems": 4
          }
        }
      }
    },
    "coinUnitPriceYen": { "type": "number", "minimum": 0 },
    "rateYenPerCoin":   { "type": "number", "minimum": 0 },
    "sigmaSpinDefault": { "type": "number", "minimum": 0 }
  },
  "$defs": {
    "fieldDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["key", "labelJP", "type"],
      "properties": {
        "key":        { "type": "string", "pattern": "^[a-zA-Z][a-zA-Z0-9_]{0,31}$" },
        "labelJP":    { "type": "string" },
        "type":       { "type": "string", "enum": ["number", "string", "boolean", "enum"] },
        "unit":       { "type": "string" },
        "placeholder":{ "type": "string" },
        "required":   { "type": "boolean", "default": false },
        "default":    {},
        "min":        { "type": "number" },
        "max":        { "type": "number" },
        "step":       { "type": "number" },
        "precision":  { "type": "integer", "minimum": 0, "maximum": 6 },
        "options": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["value", "labelJP"],
            "additionalProperties": false,
            "properties": {
              "value":   { "type": ["string", "number", "boolean"] },
              "labelJP": { "type": "string" }
            }
          }
        },
        "visible":    { "type": "boolean", "default": true },
        "mobileOnly": { "type": "boolean", "default": false },

        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "pattern": "^[A-Za-z0-9._:-]+$"
          },
          "uniqueItems": true
        }
      }
    }
  }
}
